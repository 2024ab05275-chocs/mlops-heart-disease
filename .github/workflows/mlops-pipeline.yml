name: MLOps Heart Disease Production Pipeline

on:
  push:
    branches: ["main", "ci-mlops-pipeline"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  packages: write

env:
  IMAGE_NAME: ghcr.io/${{ github.repository }}/heart-disease-api
  API_PORT: 8000

#########################################################
# 1. CODE QUALITY (Linting & Static Checks)
#########################################################
jobs:
  code_quality_checks:
    runs-on: ubuntu-latest
    steps:
      - uses: ./.github/actions/python-setup
      - name: Run Linting
        run: bash scripts/run_lint.sh

#########################################################
# 2. UNIT TESTING
#########################################################
  unit_tests:
    needs: code_quality_checks
    runs-on: ubuntu-latest
    steps:
      - uses: ./.github/actions/python-setup
      - name: Run Pytest Suite
        run: pytest tests/ -v

#########################################################
# 3. DATA PIPELINE (Ingestion + Preprocessing)
#########################################################
  data_pipeline:
    needs: unit_tests
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: ./.github/actions/python-setup
      - name: Data Acquisition
        run: python -m src.data.data_acquisition
      - name: Data Preprocessing
        run: python -m src.data.preprocess

#########################################################
# 4. MODEL TRAINING & EVALUATION
#########################################################
  model_training:
    needs: data_pipeline
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: ./.github/actions/python-setup
      - name: Train Logistic Regression
        run: python -m src.models.train_evaluate_logistic_regression
      - name: Train Random Forest
        run: python -m src.models.train_evaluate_random_forest

#########################################################
# 5. EXPERIMENT TRACKING
#########################################################
  experiment_tracking:
    needs: model_training
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: ./.github/actions/python-setup
      - name: Log Metrics & Parameters
        run: python -m src.models.experiment_tracking

#########################################################
# 6. MODEL ARTIFACT MANAGEMENT (Registry / Persistence)
#########################################################
  model_artifact_management:
    needs: experiment_tracking
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: ./.github/actions/python-setup
      - name: Save Model Artifacts
        run: python -m src.models.save_model

#########################################################
# 7. CONTAINER BUILD & PUBLISH (CI â†’ CD Boundary)
#########################################################
  container_build_and_publish:
    needs: model_artifact_management
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Build & Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:latest
            ${{ env.IMAGE_NAME }}:${{ github.sha }}

#########################################################
# 8. DEPLOYMENT
#########################################################
  deployment:
    needs: container_build_and_publish
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Authenticate to GHCR
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Deploy API Container
        run: |
          docker pull ${{ env.IMAGE_NAME }}:latest
          docker run -d --rm \
            -p ${{ env.API_PORT }}:${{ env.API_PORT }} \
            --name heart-api \
            ${{ env.IMAGE_NAME }}:latest
          sleep 10

#########################################################
# 9. POST-DEPLOYMENT VALIDATION (Smoke Tests)
#########################################################
  post_deployment_validation:
    needs: deployment
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Health Check
        run: curl -f http://localhost:8000/health

      - name: Logistic Regression Inference Test
        run: |
          curl -f -X POST http://localhost:8000/predict/logistic \
          -H "Content-Type: application/json" \
          -d @tests/sample_request.json

      - name: Random Forest Inference Test
        run: |
          curl -f -X POST http://localhost:8000/predict/random-forest \
          -H "Content-Type: application/json" \
          -d @tests/sample_request.json

#########################################################
# 10. OBSERVABILITY & LOGGING
#########################################################
  observability_and_logging:
    needs: post_deployment_validation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Fetch Prometheus Metrics
        run: curl -f http://localhost:8000/metrics

      - name: Collect API Logs
        if: always()
        run: docker logs heart-api > api_logs.txt

      - name: Upload Logs Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-logs
          path: api_logs.txt